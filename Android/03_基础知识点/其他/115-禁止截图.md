# 1. 115-ç¦æ­¢æˆªå›¾

[åŸæ–‡ï¼šAndroid ç¦æ­¢ç•Œé¢æˆªå›¾](https://www.jianshu.com/p/826001d8302f)

å¯¹äºä¸€äº›è¯¸å¦‚è¾“å…¥å¯†ç ç­‰å®‰å…¨æ€§è¾ƒé«˜çš„ç•Œé¢æ˜¯ä¸å…è®¸æˆªå›¾çš„ï¼Œåœ¨æˆªå›¾æ—¶ä¼šå¼¹å‡ºç›¸åº”çš„æç¤ºï¼Œæ¯”å¦‚è®¾ç½® PIN ç è§£é”ï¼Œåˆ†äº« WIFI æ—¶éœ€è¦è¾“å…¥å¯†ç ï¼Œè€Œæ­¤æ—¶çš„ç•Œé¢å°±ä¸å…è®¸æˆªå›¾æ“ä½œã€‚ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•å¯ç¦æ­¢ç•Œé¢æˆªå›¾

## 1.1. æ™®é€š Activity 

åœ¨ setContentView() ä¹‹å‰è·å–å…¶ window å¯¹è±¡ï¼Œç„¶ååŠ å…¥å¯¹åº”çš„ flag 

```java
getWindow().addFlags(WindowManager.LayoutParams.FLAG_SECURE);

setContentView(R.layout.activity_main);
```

## 1.2. åŠ¨æ€åŠ è½½çš„window

åŠ¨æ€åŠ è½½çš„windowä¹ŸåŒæ ·åŠ å…¥flag

```java
WindowManager.LayoutParams.FLAG_SECURE
```

## 1.3. FLAG_SECUREçš„ä½œç”¨

ä½œç”¨æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼ˆä¸æ˜¯å…¨éƒ¨ï¼‰ï¼š

* é˜»æ­¢å±å¹•æˆªå›¾;
* åœ¨ Recent apps (ä»»åŠ¡åˆ‡æ¢ç•Œé¢)ä¸­åªæ˜¾ç¤ºåº”ç”¨åå­—å’Œå›¾æ ‡, ä¸æ˜¾ç¤ºå†…å®¹;
* Google App çš„ Now on tap åŠŸèƒ½ä¸ä¼šå»åˆ†æä½ çš„é¡µé¢çš„å†…å®¹ã€‚

## 1.4. ç¤ºä¾‹

* Activity 

```java

/**
 * CnPeng:2021/8/18 11:49 WindowManager åŠ¨æ€åŠ å…¥ viewï¼Œå¹¶æµ‹è¯•ç¦æ­¢æˆªå±çš„æ“ä½œ
 *
 * å¦‚æœç›´æ¥åœ¨ onCreate ä¸­æ·»åŠ ç¦æ­¢æˆªå±çš„ flag, åˆ™è¯¥é¡µé¢å°†å®Œå…¨ä¸èƒ½æˆªå±ï¼ŒåŒ…æ‹¬é€šè¿‡ WindowManager åŠ¨æ€æ·»åŠ çš„è§†å›¾
 * å¦‚æœåœ¨é€šè¿‡ WindowManager åŠ¨æ€æ·»åŠ è§†å›¾æ—¶è®¾ç½® flag, å¹¶åœ¨åˆé€‚æ—¶æœºä¸‹è§£é™¤ flagï¼Œåˆ™å¯ä»¥åŠ¨æ€æ§åˆ¶æ˜¯å¦å¯ä»¥æˆªå±ï¼ˆ
 * * å½“å‰ demo çš„æ•ˆæœæ˜¯ï¼Œå±•ç¤ºåŠ¨æ€æ·»åŠ çš„å†…å®¹æ—¶ä¸å…è®¸æˆªå±, ä¸å±•ç¤ºæ—¶å…è®¸æˆªå±ï¼‰
 */
public class WindowManagerActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {

        // ç¦æ­¢å½“å‰é¡µé¢æˆªå±ï¼Œå¿…é¡»åœ¨ setContentView ä¹‹å‰è°ƒç”¨
        // getWindow().addFlags(WindowManager.LayoutParams.FLAG_SECURE);

        super.onCreate(savedInstanceState);

        ActivityWindowManagerBinding binding = DataBindingUtil.setContentView(this, R.layout.activity_window_manager);
        binding.btn.setOnClickListener(v -> {
            addViewByWindowManager();
        });
    }

    /**
     * CnPeng:2021/8/18 12:00 é€šè¿‡ WindowManager åŠ¨æ€çš„æ·»åŠ view
     */
    private void addViewByWindowManager() {
        WindowManager.LayoutParams mWindowParams = new WindowManager.LayoutParams();
        //        mWindowParams.gravity = Gravity.TOP|Gravity.START;
        mWindowParams.gravity = Gravity.CENTER;
        mWindowParams.x = 0;
        mWindowParams.y = 0;
        mWindowParams.height = WindowManager.LayoutParams.MATCH_PARENT;
        mWindowParams.width = WindowManager.LayoutParams.MATCH_PARENT;
        // WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE
        // | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE
        // | WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON
        // | WindowManager.LayoutParams.FLAG_LAYOUT_IN_SCREEN
        mWindowParams.flags = WindowManager.LayoutParams.FLAG_SECURE;
        mWindowParams.format = PixelFormat.TRANSLUCENT;
        mWindowParams.windowAnimations = 0;

        //  WindowManager windowManager1 = getWindowManager();
        WindowManager windowManager = (WindowManager) getSystemService(Context.WINDOW_SERVICE);

        Button textView = new Button(this);
        textView.setText("ç‚¹å‡»è¯¥æ–‡æœ¬ï¼Œå°†å–æ¶ˆç¦æ­¢ğŸš«æˆªå±çš„é™åˆ¶");
        textView.setOnClickListener(v -> {
            // å–æ¶ˆç¦æ­¢æˆªå±çš„é™åˆ¶
            getWindow().clearFlags(WindowManager.LayoutParams.FLAG_SECURE);
            //            getWindowManager().removeViewImmediate(textView);
            windowManager.removeView(textView);
        });

        windowManager.addView(textView, mWindowParams);

        //        ImageView imageView = new ImageView(this);
        //        int backGroundColor = getResources().getColor(R.color.major);
        //        imageView.setBackgroundColor(backGroundColor);
        //
        //        Bitmap bitmap = BitmapFactory.decodeResource(getResources(), R.drawable.weixin_circle);
        //        imageView.setImageBitmap(bitmap);
    }
}
```

* xml 

```xml
<?xml version="1.0" encoding="utf-8"?>
<layout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools">

    <data>
    </data>

    <androidx.constraintlayout.widget.ConstraintLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:background="@color/c_330fbc5a"
        tools:context="com.cnpeng.base.windowManager.WindowManagerActivity">

        <Button
            android:id="@+id/btn"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:gravity="center"
            android:text="è¿™æ˜¯åº•å±‚çš„ç•Œé¢ï¼Œå…è®¸æˆªå± \n ç‚¹å‡»ä¹‹åä¼šè°ƒç”¨ WindowManager æ·»åŠ è§†å›¾"
            app:layout_constraintBottom_toBottomOf="parent"
            app:layout_constraintTop_toTopOf="parent" />

    </androidx.constraintlayout.widget.ConstraintLayout>
</layout>
```