# 1. 1-gRPCåŠç›¸å…³ä»‹ç»

>2022-01-27 11:25

[ç‚¹å‡»æŸ¥çœ‹åŽŸæ–‡](https://eddycjy.com/posts/go/grpc/2018-09-22-install/)

[é¡¹ç›®åœ°å€ï¼šhttps://github.com/EDDYCJY/go-grpc-example](https://github.com/EDDYCJY/go-grpc-example)

ä½œä¸ºå¼€ç¯‡ç« ï¼Œå°†ä¼šä»‹ç» gRPC ç›¸å…³çš„ä¸€äº›çŸ¥è¯†ã€‚ç®€å•æ¥è®² gRPC æ˜¯ä¸€ä¸ª åŸºäºŽ HTTP/2 åè®®è®¾è®¡çš„ RPC æ¡†æž¶ï¼Œå®ƒé‡‡ç”¨äº† Protobuf ä½œä¸º IDLï¼ˆInterface description languageï¼ŒæŽ¥å£å®šä¹‰è¯­è¨€ï¼‰

ä½ æ˜¯å¦æœ‰è¿‡ç–‘æƒ‘ï¼Œå®ƒä»¬éƒ½æ˜¯äº›ä»€ä¹ˆï¼Ÿæœ¬æ–‡å°†ä¼šä»‹ç»ä¸€äº›å¸¸ç”¨çš„çŸ¥è¯†å’Œæ¦‚å¿µï¼Œæ›´è¯¦ç»†çš„ä¼šç»™å‡ºæ‰‹å†Œåœ°å€åŽ»æ·±å…¥

## 1.1. RPC

### 1.1.1. ä»€ä¹ˆæ˜¯ RPC

#### 1.1.1.1. å®šä¹‰

RPC ä»£æŒ‡**è¿œç¨‹è¿‡ç¨‹è°ƒç”¨**ï¼ˆRemote Procedure Callï¼‰ï¼Œå®ƒçš„è°ƒç”¨åŒ…å«äº†**ä¼ è¾“åè®®å’Œç¼–ç ï¼ˆå¯¹è±¡åºåˆ—å·ï¼‰åè®®**ç­‰ç­‰ã€‚**å…è®¸è¿è¡ŒäºŽä¸€å°è®¡ç®—æœºçš„ç¨‹åºè°ƒç”¨å¦ä¸€å°è®¡ç®—æœºçš„å­ç¨‹åºï¼Œè€Œå¼€å‘äººå‘˜æ— éœ€é¢å¤–åœ°ä¸ºè¿™ä¸ªäº¤äº’ä½œç”¨ç¼–ç¨‹ã€‚**

#### 1.1.1.2. ä½¿ç”¨åœºæ™¯ï¼š

æœ‰ä¸¤å°æœåŠ¡å™¨ï¼Œåˆ†åˆ«æ˜¯ Aã€Bã€‚åœ¨ A ä¸Šçš„åº”ç”¨ C æƒ³è¦è°ƒç”¨ B æœåŠ¡å™¨ä¸Šçš„åº”ç”¨ Dï¼Œå®ƒä»¬å¯ä»¥ç›´æŽ¥æœ¬åœ°è°ƒç”¨å—ï¼Ÿ

ç­”æ¡ˆæ˜¯ä¸èƒ½çš„ï¼Œä½†èµ° RPC çš„è¯ï¼Œååˆ†æ–¹ä¾¿ã€‚å› æ­¤å¸¸æœ‰äººç§°ä½¿ç”¨ RPCï¼Œå°±è·Ÿæœ¬åœ°è°ƒç”¨ä¸€ä¸ªå‡½æ•°ä¸€æ ·ç®€å•ã€‚

### 1.1.2. RPC æ¡†æž¶

æˆ‘è®¤ä¸ºï¼Œä¸€ä¸ªå®Œæ•´çš„ RPC æ¡†æž¶ï¼Œåº”åŒ…å«**è´Ÿè½½å‡è¡¡**ã€**æœåŠ¡æ³¨å†Œå’Œå‘çŽ°**ã€**æœåŠ¡æ²»ç†**ç­‰åŠŸèƒ½ï¼Œå¹¶å…·æœ‰**å¯æ‹“å±•æ€§ä¾¿äºŽæµé‡ç›‘æŽ§ç³»ç»Ÿç­‰æŽ¥å…¥**ï¼Œè¿™æ ·å®ƒæ‰ç®—å®Œæ•´çš„ã€‚å½“ç„¶äº†ï¼Œæœ‰äº›è¾ƒå•ä¸€çš„ RPC æ¡†æž¶ï¼Œé€šè¿‡ç»„åˆå¤šç»„ä»¶ä¹Ÿèƒ½è¾¾åˆ°è¿™ä¸ªæ ‡å‡†ã€‚

ä½ è®¤ä¸ºå‘¢ï¼Ÿ

### 1.1.3. å¸¸è§ RPC æ¡†æž¶

* [gRPC](https://grpc.io/)
* [Thrift](https://github.com/apache/thrift)
* [Rpcx](https://github.com/smallnest/rpcx)
* [Dubbo](https://github.com/apache/incubator-dubbo)

#### 1.1.3.1. æ¯”è¾ƒä¸€ä¸‹

æ¡†æž¶ | è·¨è¯­è¨€ | å¤š IDL | æœåŠ¡æ²»ç† | æ³¨å†Œä¸­å¿ƒ | æœåŠ¡ç®¡ç†
---|---|---|---|---|---
gRPC | âˆš | Ã— | Ã— | Ã— | Ã—
Thrift | âˆš | Ã— | Ã— | Ã— | Ã—
Rpcx | Ã— | âˆš | âˆš | âˆš | âˆš
Dubbo | Ã— | âˆš | âˆš | âˆš | âˆš

#### 1.1.3.2. ä¸ºä»€ä¹ˆè¦ RPC

ç®€å•ã€é€šç”¨ã€å®‰å…¨ã€æ•ˆçŽ‡

#### 1.1.3.3. RPC å¯ä»¥åŸºäºŽ HTTP å—

RPC æ˜¯ä»£æŒ‡**è¿œç¨‹è¿‡ç¨‹è°ƒç”¨**ï¼Œæ˜¯å¯ä»¥åŸºäºŽ HTTP åè®®çš„

è‚¯å®šä¼šæœ‰äººè¯´æ•ˆçŽ‡ä¼˜åŠ¿ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½ ï¼Œé‚£æ˜¯åŸºäºŽ HTTP/1.1 æ¥è®²çš„ï¼ŒHTTP/2 ä¼˜åŒ–äº†è®¸å¤šé—®é¢˜ï¼ˆå½“ç„¶ä¹Ÿå­˜åœ¨æ–°çš„é—®é¢˜ï¼‰ï¼Œæ‰€ä»¥ä½ çœ‹åˆ°äº†æœ¬æ–‡çš„ä¸»é¢˜ gRPC

## 1.2. Protobuf

[æ›´å¤šå†…å®¹å¯å‚è€ƒï¼šã€ŠProto3ä½¿ç”¨æŒ‡å—ã€‹--åšå®¢å›­](https://www.cnblogs.com/lianshuiwuyi/p/12221913.html)

### 1.2.1. ä»‹ç»

[Protocol Buffers]([https://github.com/protocolbuffers/protobuf](https://github.com/protocolbuffers/protobuf)) æ˜¯ä¸€ç§ä¸Žè¯­è¨€ã€å¹³å°æ— å…³ï¼Œå¯æ‰©å±•çš„**åºåˆ—åŒ–ç»“æž„åŒ–æ•°æ®çš„æ–¹æ³•**ï¼Œå¸¸ç”¨äºŽé€šä¿¡åè®®ï¼Œæ•°æ®å­˜å‚¨ç­‰ç­‰ã€‚ç›¸è¾ƒäºŽ JSONã€XMLï¼Œå®ƒæ›´å°ã€æ›´å¿«ã€æ›´ç®€å•ï¼Œå› æ­¤ä¹Ÿæ›´å—å¼€å‘äººå‘˜çš„é’çœ¯

### 1.2.2. è¯­æ³•

```/
syntax = "proto3";

service SearchService {
    rpc Search (SearchRequest) returns (SearchResponse);
}

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 result_per_page = 3;
}

message SearchResponse {
    ...
}
```

* ç¬¬ä¸€è¡Œï¼ˆéžç©ºçš„éžæ³¨é‡Šè¡Œï¼‰å£°æ˜Žä½¿ç”¨ proto3 è¯­æ³•ã€‚å¦‚æžœä¸å£°æ˜Žï¼Œå°†é»˜è®¤ä½¿ç”¨ proto2 è¯­æ³•ã€‚åŒæ—¶æˆ‘å»ºè®®ä¸è®ºæ˜¯ç”¨ v2 è¿˜æ˜¯ v3ï¼Œéƒ½åº”å½“æ˜¾ç¤ºå£°æ˜Žè¯¥ç‰ˆæœ¬
* å®šä¹‰ `SearchService` RPC æœåŠ¡ï¼Œå…¶åŒ…å« RPC æ–¹æ³• `Search` ï¼Œå…¥å‚ä¸º `SearchRequest` æ¶ˆæ¯ï¼Œå‡ºå‚ä¸º `SearchResponse` æ¶ˆæ¯
* å®šä¹‰ `SearchRequest` ã€ `SearchResponse` æ¶ˆæ¯ï¼Œå‰è€…å®šä¹‰äº†ä¸‰ä¸ªå­—æ®µï¼Œæ¯ä¸€ä¸ªå­—æ®µåŒ…å«ä¸‰ä¸ªå±žæ€§ï¼šç±»åž‹ã€å­—æ®µåç§°ã€å­—æ®µç¼–å·
* Protobuf ç¼–è¯‘å™¨ä¼šæ ¹æ®é€‰æ‹©çš„è¯­è¨€ä¸åŒï¼Œç”Ÿæˆç›¸åº”è¯­è¨€çš„ `Service Interface Code` å’Œ `Stubs`

æœ€åŽï¼Œè¿™é‡Œåªæ˜¯ç®€å•çš„è¯­æ³•ä»‹ç»ï¼Œè¯¦ç»†çš„è¯·å³æ‹ [Language Guide (proto3)](https://developers.google.com/protocol-buffers/docs/proto3)

### 1.2.3. æ•°æ®ç±»åž‹

.proto Type | C++ Type  | Java Type | Go Type	 | PHP Type
---|---|---|---|---
double	 | double	 | double	 | float64	 | float
float	        | float	 | float	 | float32	 | float
int32	 | int32	 | int	        | int32	 | integer
int64	 | int64	 | long	 | int64	 | integer/string
uint32	 | uint32	 | int	        | uint32	 | integer
uint64	 | uint64	 | long	 | uint64	 | integer/string
sint32	 | int32	 | int	        | int32	 | integer
sint64	 | int64	 | long	 | int64	 | integer/string
fixed32	 | uint32	 | int	        | uint32	 | integer
fixed64	 | uint64	 | long	 | uint64	 | integer/string
sfixed32	 | int32	 | int	        | int32	 | integer
sfixed64	 | int64	 | long	 | int64	 | integer/string
bool	        | bool	 | boolean | bool	 | boolean
string	 | string	 | String	 | string	 | string
bytes	 | string	 | ByteString	 | []byte	 | string

### 1.2.4. v2 å’Œ v3 ä¸»è¦åŒºåˆ«

* åˆ é™¤åŽŸå§‹å€¼å­—æ®µçš„å­—æ®µå­˜åœ¨é€»è¾‘
* åˆ é™¤ required å­—æ®µ
* åˆ é™¤ optional å­—æ®µï¼Œé»˜è®¤å°±æ˜¯
* åˆ é™¤ default å­—æ®µ
* åˆ é™¤æ‰©å±•ç‰¹æ€§ï¼Œæ–°å¢ž Any ç±»åž‹æ¥æ›¿ä»£å®ƒ
* åˆ é™¤ unknown å­—æ®µçš„æ”¯æŒ
* æ–°å¢ž [JSON Mapping](https://developers.google.com/protocol-buffers/docs/proto3#json)
* æ–°å¢ž Map ç±»åž‹çš„æ”¯æŒ
* ä¿®å¤ enum çš„ unknown ç±»åž‹
* repeated é»˜è®¤ä½¿ç”¨ packed ç¼–ç 
* å¼•å…¥äº†æ–°çš„è¯­è¨€å®žçŽ°ï¼ˆCï¼ƒï¼ŒJavaScriptï¼ŒRubyï¼ŒObjective-Cï¼‰

ä»¥ä¸Šæ˜¯æ—¥å¸¸æ¶‰åŠçš„å¸¸è§åŠŸèƒ½ï¼Œå¦‚æžœè¿˜æƒ³è¯¦ç»†äº†è§£å¯é˜…è¯» [Protobuf Version 3.0.0](https://github.com/protocolbuffers/protobuf/releases?after=v3.2.1)

### 1.2.5. ç›¸è¾ƒ Protobufï¼Œä¸ºä»€ä¹ˆä¸ä½¿ç”¨ XMLï¼Ÿ

* æ›´ç®€å•
* æ•°æ®æè¿°æ–‡ä»¶åªéœ€åŽŸæ¥çš„ 1/10 è‡³ 1/3
* è§£æžé€Ÿåº¦æ˜¯åŽŸæ¥çš„ 20 å€è‡³ 100 å€
* å‡å°‘äº†äºŒä¹‰æ€§
* ç”Ÿæˆäº†æ›´æ˜“ä½¿ç”¨çš„æ•°æ®è®¿é—®ç±»

## 1.3. gRPC

### 1.3.1. ä»‹ç»

gRPC æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½ã€å¼€æºå’Œé€šç”¨çš„ RPC æ¡†æž¶ï¼Œé¢å‘ç§»åŠ¨å’Œ HTTP/2 è®¾è®¡

### 1.3.2. å¤šè¯­è¨€

* C++
* C#
* Dart
* Go
* Java
* Node.js
* Objective-C
* PHP
* Python
* Ruby

### 1.3.3. ç‰¹ç‚¹

* HTTP/2
* Protobuf
* å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯åŸºäºŽåŒä¸€ä»½ IDL
* ç§»åŠ¨ç½‘ç»œçš„è‰¯å¥½æ”¯æŒ
* æ”¯æŒå¤šè¯­è¨€

### 1.3.4. æ¦‚è§ˆ

![](pics/20220127121546512_172987035.png)

### 1.3.5. è®²è§£

* å®¢æˆ·ç«¯ï¼ˆgRPC Subï¼‰è°ƒç”¨ A æ–¹æ³•ï¼Œå‘èµ· RPC è°ƒç”¨
* å¯¹è¯·æ±‚ä¿¡æ¯ä½¿ç”¨ Protobuf è¿›è¡Œå¯¹è±¡åºåˆ—åŒ–åŽ‹ç¼©ï¼ˆIDLï¼‰
* æœåŠ¡ç«¯ï¼ˆgRPC Serverï¼‰æŽ¥æ”¶åˆ°è¯·æ±‚åŽï¼Œè§£ç è¯·æ±‚ä½“ï¼Œè¿›è¡Œä¸šåŠ¡é€»è¾‘å¤„ç†å¹¶è¿”å›ž
* å¯¹å“åº”ç»“æžœä½¿ç”¨ Protobuf è¿›è¡Œå¯¹è±¡åºåˆ—åŒ–åŽ‹ç¼©ï¼ˆIDLï¼‰
* å®¢æˆ·ç«¯æŽ¥æ”¶åˆ°æœåŠ¡ç«¯å“åº”ï¼Œè§£ç è¯·æ±‚ä½“ã€‚å›žè°ƒè¢«è°ƒç”¨çš„ A æ–¹æ³•ï¼Œå”¤é†’æ­£åœ¨ç­‰å¾…å“åº”ï¼ˆé˜»å¡žï¼‰çš„å®¢æˆ·ç«¯è°ƒç”¨å¹¶è¿”å›žå“åº”ç»“æžœ

### 1.3.6. ç¤ºä¾‹

åœ¨è¿™ä¸€å°èŠ‚ï¼Œå°†ç®€å•çš„ç»™å¤§å®¶å±•ç¤º gRPC çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç¤ºä¾‹ä»£ç ï¼Œå¸Œæœ›å¤§å®¶å…ˆæœ‰ä¸€ä¸ªåŸºç¡€çš„å°è±¡ï¼Œå°†ä¼šåœ¨ä¸‹ä¸€ç« èŠ‚è¯¦ç»†ä»‹ç» ðŸ¤”

#### 1.3.6.1. æž„å»ºå’Œå¯åŠ¨æœåŠ¡ç«¯

```go
lis, err := net.Listen("tcp", fmt.Sprintf(":%d", *port))
if err != nil {
        log.Fatalf("failed to listen: %v", err)
}

grpcServer := grpc.NewServer()
...
pb.RegisterSearchServer(grpcServer, &SearchServer{})
grpcServer.Serve(lis)
```

* ç›‘å¬æŒ‡å®š TCP ç«¯å£ï¼Œç”¨äºŽæŽ¥å—å®¢æˆ·ç«¯è¯·æ±‚
* åˆ›å»º gRPC Server çš„å®žä¾‹å¯¹è±¡
* gRPC Server å†…éƒ¨æœåŠ¡å’Œè·¯ç”±çš„æ³¨å†Œ
* `Serve()` è°ƒç”¨æœåŠ¡å™¨ä»¥æ‰§è¡Œé˜»å¡žç­‰å¾…ï¼Œç›´åˆ°è¿›ç¨‹è¢«ç»ˆæ­¢æˆ–è¢« `Stop()` è°ƒç”¨

#### 1.3.6.2. åˆ›å»ºå®¢æˆ·ç«¯

```go
var opts []grpc.DialOption
...
conn, err := grpc.Dial(*serverAddr, opts...)
if err != nil {
    log.Fatalf("fail to dial: %v", err)
}

defer conn.Close()
client := pb.NewSearchClient(conn)
...
```

* åˆ›å»º gRPC Channel ä¸Ž gRPC Server è¿›è¡Œé€šä¿¡ï¼ˆéœ€æœåŠ¡å™¨åœ°å€å’Œç«¯å£ä½œä¸ºå‚æ•°ï¼‰
* è®¾ç½® DialOptions å‡­è¯ï¼ˆä¾‹å¦‚ï¼ŒTLSï¼ŒGCE å‡­æ®ï¼ŒJWT å‡­è¯ï¼‰
* åˆ›å»º Search Client Stub
* è°ƒç”¨å¯¹åº”çš„æœåŠ¡æ–¹æ³•

## 1.4. æ€è€ƒé¢˜

* ä»€ä¹ˆåœºæ™¯ä¸‹ä¸é€‚åˆä½¿ç”¨ Protobufï¼Œè€Œé€‚åˆä½¿ç”¨ JSONã€XMLï¼Ÿ
* Protobuf ä¸€èŠ‚ä¸­æåˆ°çš„ packed ç¼–ç ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ

## 1.5. æ€»ç»“

åœ¨å¼€ç¯‡å†…å®¹ä¸­ï¼Œæˆ‘åˆ©ç”¨äº†å°½é‡ç®€çŸ­çš„æè¿°ç»™ä½ ä»‹ç»äº†æŽ¥ä¸‹æ¥æ‰€å¿…é¡»ã€å¿…è¦çš„çŸ¥è¯†ç‚¹ å¸Œæœ›ä½ èƒ½å¤Ÿæœ‰æ‰€æ”¶èŽ·ï¼Œå»ºè®®èƒ½åˆ°æˆ‘ç»™çš„å‚è€ƒèµ„æ–™å¤„è¿›è¡Œæ·±å…¥å­¦ä¹ ï¼Œæ˜¯æœ€å¥½çš„äº†

## 1.6. å‚è€ƒèµ„æ–™

* [Protocol Buffers](https://developers.google.com/protocol-buffers/docs/proto3)
* [gRPC](https://grpc.io/docs/)

## 1.7. è¡¥å……

> æ‘˜è‡ªåŽŸæ–‡è¯„è®ºåŒº

* ä»€ä¹ˆåœºæ™¯ä¸‹ä¸é€‚åˆä½¿ç”¨ Protobufï¼Œè€Œé€‚åˆä½¿ç”¨ JSONã€XMLï¼Ÿ

åœ¨è°ƒè¯•æˆæœ¬æ¯”è¾ƒé«˜çš„åœºæ™¯ä¸‹, ä½¿ç”¨ JSON/XML è¿™ç§äººçœ¼å¯è¯»çš„åè®®, èƒ½å¤Ÿæ›´æ–¹ä¾¿æµ‹è¯•äººå‘˜çš„ç†è§£;
å¦å¤–, åœ¨ä¸æ”¯æŒ Protobuf ç¼–è§£ç çš„åŠ¨æ€ç¼–ç¨‹è¯­è¨€ä¸­, ä¹Ÿå¯ä»¥è€ƒè™‘ JSON/XML;

æ„Ÿè§‰è¿™ç¯‡æ–‡ç« æ€»ç»“çš„æŒºå…¨é¢çš„ï¼š[ã€Šåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‹â€”â€”ç¾Žå›¢æŠ€æœ¯å›¢é˜Ÿ](https://tech.meituan.com/2015/02/26/serialization-vs-deserialization.html)



* Protobuf ä¸€èŠ‚ä¸­æåˆ°çš„ packed ç¼–ç ï¼Œæ˜¯ä»€ä¹ˆï¼Ÿ

```go
message Test4 {
  repeated int32 d = 4 [packed=true];
}
```

èµ‹å€¼:

```go
Test4.d = []int32{3, 270, 86942}
```

d ç¼–ç åŽ(16 è¿›åˆ¶): `22 06 03 8E 02 9E A7 05`
d ç¼–ç åŽ(16 è¿›åˆ¶ -> äºŒè¿›åˆ¶):

```/
22 -> 010 0(field number = 4) 010 (wire type = 2)
06 -> payload size = 6
03 -> ç¬¬ä¸€ä¸ªå…ƒç´ ä¸º 3
8E 02 -> ç¬¬äºŒä¸ªå…ƒç´ ä¸º 270
8E 02 -> ç¬¬ä¸‰ä¸ªå…ƒç´ ä¸º 86942
```